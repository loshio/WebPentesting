# Attacking Data Stores

- [Attacking Data Stores](#attacking-data-stores)
  - [Injecting into Interpreted Contexts](#injecting-into-interpreted-contexts)
    - [Bypassing a Login](#bypassing-a-login)
  - [Injecting into SQL](#injecting-into-sql)
    - [Exploiting a Basic Vulnerability](#exploiting-a-basic-vulnerability)
      - [Alternatives to Dealing with Trailing Quotes](#alternatives-to-dealing-with-trailing-quotes)
    - [Injecting into Different Statement Types](#injecting-into-different-statement-types)

## Injecting into Interpreted Contexts

There are really only two main types of languages out there: compiled and interpreted. Compiled means that the code is turned into a binary file, while interpreted means that the code stays in the source format until runtime and is interpreted as it is run.

For whatever reason, the languages used to make web applications tend to be interpreted, a couple examples are: ```JS```, ```SQL```, ```LDAP```, ```Perl```, and ```PHP```. Given this, there is a larger chance of a certain type of vulnerability to show up, which is code injection.

### Bypassing a Login

In many cases where a web application has to access a data store to retrive information, it usually involves some sort of query. In security-sensitive logic such as loggin in, a query might looks something like:

    SELECT * FROM users WHERE username = ‘marcus’ and password = ‘secret’

This query will cause the db to check every row within the users table and extract each record where the <i>username</i> column has the value of ```marcus``` and the <i>password</i> column has the value of ```secret```.

One thing that could be done in this scenario is the use of modifying the logic. so let's say that the username of the site admin is ```admin```. This could be user in an attack that looks like:

    admin'--

The login is that the word ```admin``` was added and then completed with the single quotation mark. This would complete the statement and then you can add a comment of "```--```" that would comment the rest of the query, essentially bypassing the login. The final query would look like this:

    SELECT * FROM users WHERE username = ‘admin’--’ AND password = ‘foo’

This means that the query would look like this to the application:

    SELECT * FROM users WHERE username = ‘admin’

So the login is bypassed.

There are other behaviors that are exploitable such as using login within the query. For instance, if you do not know the username of the administrator, then you can try exploiting the logic of a given query. Example:

    ' OR 1=1--

This comments out the query with no username but gives another logic expression that returns ```true``` for all queries. The ```1=1``` section tests to see if 1=1, and indeed it does, which returns ```true```. Then the expression is closed out by the comment. The final expression would look like:

    SELECT * FROM users WHERE username = ‘’ OR 1=1--’ AND password = ‘foo’

    Thus the computer sees:

    SELECT * FROM users WHERE username = ‘’ OR 1=1

This would return all the details of all application users.

## Injecting into SQL

Databases are employed across many different applications in order to store information. They essentially have four different methods for interacting with data, which are: ```read```, ```update```, ```add```, and ```delete```. SQL injections can be devestating to a web application, but with the use of APIs, has become way moe diffucult. The main SQL servers are: Oracle, MS-SQL, and MySQL.

### Exploiting a Basic Vulnerability

So let's say that there is an online bookstore that allows you to search through a catalog of books. This server is using a SQL DB. When a search happens, this query is run:

    SELECT author,title,year FROM books WHERE publisher = ‘Wiley’ and published=1

Note a couple things:
- The words left of the equals symbol are SQL keywords and names of tables and columns within the DB.
  - This portion of the query was contructed by the programmer when the application was created.
- The expression ```Wiley``` is supplied by the user.
- String data (the ```Wiley``` expression) must be encapsulated within single quotation marks to seperate it from the rest of the query.

So given he query example, what would happen if we searched the publisher ```O'Reilly``` instead of ```Wiley```. The query would look something like:

    SELECT author,title,year FROM books WHERE publisher = ‘O’Reilly’ and published=1

In this case the query reaches the ```O'Reilly``` part, takes the ```O``` has the string and then encouters the expression ```Reilly```, which isn't an SQL expression, which generates the error:

    Incorrect syntax near ‘Reilly’.
    Server: Msg 105, Level 15, State 1, Line 1
    Unclosed quotation mark before the character string ‘

If the application behaves this way, it is wide open to SQL injection. Thus the attacker can:
1. Add a quotation mark to terminate the string.
2. Then write arbitrary SQL to modify the query.

Thus the user can run:

    Wiley' or 1=1--

Which looks like this on the server's end:

    SELECT author,title,year FROM books WHERE publisher = ‘Wiley’ OR 1=1--’ and published=1

This modifies the ```WHERE``` clause to add a second condition. In this case when it checks if the user is ```Wiley```, the compared element may be ```potato```, but the second condition of ```1=1``` is always true, so the DB returns everything in the ```books``` table. Then the double hyphen ```--``` comments out the rest of the query. This is important as if this wasn't done, there would be an error in the expression. This allows the rest of the expression written by the programmer be ignored. This also did a thing that allowed the attacker to return the results of the unpublished books as the ```published``` expression was commented out.

<b>NOTE:</b> in MySQL, you need to include a space after the double hyphen, or use a hash character to specify the comment.

#### Alternatives to Dealing with Trailing Quotes

You may find that comments may not be handled well and thus you could compare strings to get the same effect as the ```1=1``` condition. For example:

    Wiley' OR 'a' = 'a

This results in the final query looking like:

    SELECT author,title,year FROM books WHERE publisher = ‘Wiley’ OR ‘a’=’a’ and published=1

### Injecting into Different Statement Types

