# Attacking Access Controls

## Directory

**[Completely Unprotected Functionality](#Completely-Unprotected-Functionality)**<br>
**[Identifier-Based Functions](#Identifier-Based-Functions)**<br>
**[Multistage Functions](#Multistage-Functions)**<br>
**[Static Files](#Static-Files)**<br>
**[Platform Misconfiguration](#Platform-Misconfiguration)**<br>
**[Insecure Access Control Methods](#Insecure-Access-Control-Methods)**<br>
**[Testing with Different User Accounts](#Testing-with-Different-User-Accounts)**<br>
**[Testing Multistage Processes](#Testing-Multistage-Processes)**<br>
**[Testing with Limited Access](#Testing-with-Limited-Access)**<br>
**[Testing Direct Access to Methods](#Testing-Direct-Access-to-Methods)**<br>
**[Testing Controls Over Static Resources](#Testing-Controls-Over-Static-Resources)**<br>
**[Testing Restrictions on HTTP Methods](#Testing-Restrictions-on-HTTP-Methods)**<br>
**[Securing Access Controls](#Securing-Access-Controls)**

Access Control mechanisms make sure that users don't do the things that they shouldn't. Within performing certain unautherized actions are three main categories:

- Vertical
    - To admin or elevated level user
- Horizontal
    - To another user of the same level
- Context-dependent
    - Doing something that the user cannot do. This means that if trying to press a button in a video game before you have the key and you bypass the access control, you get to press the button. Or another example is bypassing the payment process in a shopping site.

## Completely Unprotected Functionality

There may be an unprotected URL such as:

    https://example.com/admin/

    or

    https://example.com/4fsag/admin

Where the only protection is that logged in admins will see the hyperlink to the link, while other users will not. It is purely cosmetic. Notice the second one is slightly cryptic, but still open to access controls.

While this link may not be seen, sometimes it can be found within the sourcecode of the site. Think dynamic js that is given to display the link if the user was a admin.

Othertimes, there may be APIs available that give access to certain methods that are a must to the application. A URL used may be:

    https://example.com/securityCheck/getCurrentUserRoles

This method from the API is an indicated that you should check other methods with the same naming conventions. Some example are: ```getAllUsers```, ```getAllRoles```, ```getAllUserRoles```, and ```getCurrentUserPermissions```.

## Identifier-Based Functions

There may be URLs that access specific resources for example, you, a user see a link to a document created through the site, you might be able to copy the URL and access the document as another user or even completely unauthorized. Example url for this is:

    https://example.com/ViewDocument.php?docid=174560876

<b>Note:</b> This is common to see when a site is using an external system to perform the request, where sharing session-based security tokens are present. This is diffucult for developers to make and share tokens between the systems.

## Multistage Functions

Understand that there may be multiple stages to a process. Thus if there is an application that involves three steps, for instance: account creation.

    1. Create Account
        - Needs admin's user/pass
    2. Put in details of account
    3. Validate account details input
    4. Account Creation

The first step of this may not be able to be bypasses via a link, but stage 2 may be as the developers assumed that the person already was validated from step 1, thus they didn't check and you can create a new account. This could even mean an admin account in some instances.

## Static Files

Some resources may be static in nature, that is just a link that anybody can access. For instance an e-book site, in this scenario, you may buy the book and then are given a link to the book. Maybe something like:

    https://example.com/download/9780636628104.pdf

This number may not even be randomly generated but an ISBN. So, try to undestand the naming scheme.

## Platform Misconfiguration

A resource may be blocked to only admin level users. You usually get that resource through a ```get``` request. The system configuration may have a firewall type policy that blocks get requests from non-admin users. Thus, if the platform is request agnostic, such as a lot of APIs, then you may be able to retrieve the resource with a different type of request such as ```post```.

Another example is that both ```get``` and ```post``` methods are blocked. Even with this being the case, another may be used: ```head```. This is usually just for getting the headers of a specific resource with no body, but the request usually goes through. Thus is an admin user can be created through a ```head``` request, then the attacker can successfully bypass the system controls.

Lastly, but not sure how often this happens, but there may be a catch rule that does a thing where if an unofficial HTTP method is given, the server side code will just pass it to the get request handler to process it. Thus bypassing the firewall like controls.

## Insecure Access Control Methods

### Parameter-Based Access Control

Some admin privileges may be safeguarded by some sort of parameter. This could be a query string, hidden form field, or a cookie. Example:

    https://example.com/login/home.jsp?admin=true

### Referer-Based Access Control

Some applications may check whether the user was refered to from the admin panel to make decisions. Thus if the ```referer``` tag was set to the path of the admin panel, then the admin function could be run potentially.

### Location-Based Access Control

There may be geological restrictions, thus you can use a web proxy or VPN to access said resource. But there may be more that checking IP address for location, thus look at client-side controls for finding a location.

## Testing with Different User Accounts

The most effective way to test the effectiveness of an application's access controls is through the use of multiple accounts. Ths way you can see if users can access resources that they aren't supposed to have access to. (Horizontal escalation)

Through this is a tedious process of testing access control mechanisms, tools can help. Burp Suite has a tool for mapping the contents of an application through 2 different user contexts.

## Testing Multistage Processes

This type of testing is fundamentally different than that of the previous one. This is because these types of processes have states that contribute the process. Thus keep track of the various requests and actions performed for each user.

Burp can help with this with its "request in browser in current browser session". This feature allows burp to give you a URL while each redirection can be passed through Burp to replace the Cookie header.

## Testing with Limited Access

If you only have access to one account then further work is needed in identifying potential vulnerabilities. This means to find whenever certain access to materials is given, thus try unautherized access to it, thus you still have two types of users.

## Testing Direct Access to Methods

Look for APIs that may be vulnerable to accessing certain requests and then try other methods that could potentially be run by this API.

## Testing Controls Over Static Resources

For casess where the application is protecting static resources, you should test to see if unauthorized users can simply request these URLs directly.

## Testing Restrictions on HTTP Methods

See if certain methods are blocked or not blocked, an example would be accessing a request via the ```head``` method compared to ```get``` or ```post```.

## Securing Access Controls

1. Do not rely on obfuscated URLs
1. No user-submited parameters to signify access rights
    - example: ```admin=true```
1. Do not assume that the sequence to reqeusts will be followed in order.
1. Continuosly evaluate access control requirements for every unit of the application.
1. Drive all access control decisions via the user's session.
1. Use a centralized access component to check access controls.
    - Process every client request through this component to validate that the user making the request is permitted.
1. Feel free to add requirements such as adding a required IP range, this means that the user has to come from within a certain part of the network to get to login to admin.
1. Log events where senstive functions and events occur.

### Using a Multilayered Privilege Model

Use tiers that have specific requirements and limit each user to that of wahts absolutely needed. Use a privilege matrix to help decide this.
